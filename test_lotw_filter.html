<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест LoTW фильтрации</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .filter-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .results-section { margin: 20px 0; }
        .loading { display: none; color: blue; }
        .error { color: red; }
        .success { color: green; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .pagination { margin: 20px 0; }
        .pagination button { margin: 0 5px; padding: 5px 10px; }
    </style>
</head>
<body>
    <h1>Тест LoTW AJAX фильтрации</h1>
    
    <div class="filter-section">
        <h3>Фильтры</h3>
        <label>Мой позывной: <input type="text" id="my_callsign" placeholder="Мой позывной"></label><br>
        <label>Позывной: <input type="text" id="search_callsign" placeholder="Позывной"></label><br>
        <label>QTH: <input type="text" id="search_qth" placeholder="QTH локатор"></label><br>
        <label>Диапазон: 
            <select id="band">
                <option value="">Все</option>
                <option value="160m">160m</option>
                <option value="80m">80m</option>
                <option value="40m">40m</option>
                <option value="20m">20m</option>
                <option value="15m">15m</option>
                <option value="10m">10m</option>
                <option value="2m">2m</option>
                <option value="70cm">70cm</option>
            </select>
        </label><br>
        <label>Режим: 
            <select id="mode">
                <option value="">Все</option>
                <option value="SSB">SSB</option>
                <option value="CW">CW</option>
                <option value="FT8">FT8</option>
                <option value="FT4">FT4</option>
                <option value="RTTY">RTTY</option>
            </select>
        </label><br>
        <label>Спутник: <input type="text" id="sat_name" placeholder="Спутник"></label><br>
        
        <button onclick="applyFilters()">Применить фильтры</button>
        <button onclick="clearFilters()">Очистить</button>
        <div class="loading" id="loading">Загрузка...</div>
    </div>
    
    <div class="results-section">
        <h3>Результаты</h3>
        <div id="stats"></div>
        <table id="results-table">
            <thead>
                <tr>
                    <th>Дата</th>
                    <th>Время</th>
                    <th>Мой позывной</th>
                    <th>Позывной</th>
                    <th>Диапазон</th>
                    <th>Режим</th>
                    <th>QTH</th>
                    <th>LoTW дата</th>
                </tr>
            </thead>
            <tbody id="results-body">
                <tr><td colspan="8">Нет данных</td></tr>
            </tbody>
        </table>
        
        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        let csrfToken = '';
        
        // Получаем CSRF токен
        async function getCsrfToken() {
            try {
                const response = await fetch('/lotw/');
                const html = await response.text();
                const match = html.match(/name="csrfmiddlewaretoken" value="([^"]+)"/);
                if (match) {
                    csrfToken = match[1];
                    console.log('CSRF token получен');
                }
            } catch (error) {
                console.error('Ошибка получения CSRF токена:', error);
            }
        }
        
        // Применяем фильтры
        async function applyFilters(page = 1) {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            const filterData = {
                my_callsign: document.getElementById('my_callsign').value,
                search_callsign: document.getElementById('search_callsign').value,
                search_qth: document.getElementById('search_qth').value,
                band: document.getElementById('band').value,
                mode: document.getElementById('mode').value,
                sat_name: document.getElementById('sat_name').value,
                page: page
            };
            
            console.log('Отправляемые данные:', filterData);
            
            try {
                const response = await fetch('/api/lotw/filter/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(filterData),
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                console.log('Ответ сервера:', data);
                
                if (data.success) {
                    updateResults(data);
                    showMessage('Фильтры применены успешно!', 'success');
                } else {
                    throw new Error(data.error || 'Неизвестная ошибка');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                showMessage('Ошибка фильтрации: ' + error.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Обновляем результаты на странице
        function updateResults(data) {
            // Обновляем статистику
            const stats = document.getElementById('stats');
            stats.innerHTML = `
                <p><strong>Всего записей:</strong> ${data.total_count}</p>
                <p><strong>Текущая страница:</strong> ${data.current_page} из ${data.total_pages}</p>
                <p><strong>DXCC entities:</strong> ${data.dxcc_entities}</p>
            `;
            
            // Обновляем таблицу
            const tbody = document.getElementById('results-body');
            if (data.qso_data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">Записи не найдены</td></tr>';
            } else {
                tbody.innerHTML = data.qso_data.map(qso => `
                    <tr>
                        <td>${qso.date}</td>
                        <td>${qso.time}</td>
                        <td>${qso.my_callsign}</td>
                        <td>${qso.callsign}</td>
                        <td>${qso.band || qso.frequency || '-'}</td>
                        <td>${qso.mode}</td>
                        <td>${qso.gridsquare || '-'}</td>
                        <td>${qso.lotw_date}</td>
                    </tr>
                `).join('');
            }
            
            // Обновляем пагинацию
            updatePagination(data);
        }
        
        // Обновляем пагинацию
        function updatePagination(data) {
            const pagination = document.getElementById('pagination');
            if (data.total_pages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHtml = '';
            
            // Предыдущая страница
            if (data.current_page > 1) {
                paginationHtml += `<button onclick="applyFilters(${data.current_page - 1})">Предыдущая</button>`;
            }
            
            // Номера страниц
            for (let i = 1; i <= Math.min(data.total_pages, 5); i++) {
                if (i === data.current_page) {
                    paginationHtml += `<button disabled>${i}</button>`;
                } else {
                    paginationHtml += `<button onclick="applyFilters(${i})">${i}</button>`;
                }
            }
            
            // Следующая страница
            if (data.current_page < data.total_pages) {
                paginationHtml += `<button onclick="applyFilters(${data.current_page + 1})">Следующая</button>`;
            }
            
            pagination.innerHTML = paginationHtml;
        }
        
        // Очищаем фильтры
        function clearFilters() {
            document.getElementById('my_callsign').value = '';
            document.getElementById('search_callsign').value = '';
            document.getElementById('search_qth').value = '';
            document.getElementById('band').value = '';
            document.getElementById('mode').value = '';
            document.getElementById('sat_name').value = '';
            
            applyFilters(1);
        }
        
        // Показываем сообщения
        function showMessage(message, type) {
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.style.cssText = 'padding: 10px; margin: 10px 0; border-radius: 5px;';
            messageDiv.style.backgroundColor = type === 'success' ? '#d4edda' : '#f8d7da';
            messageDiv.style.color = type === 'success' ? '#155724' : '#721c24';
            messageDiv.textContent = message;
            
            document.body.insertBefore(messageDiv, document.querySelector('.filter-section'));
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            getCsrfToken();
            // Загружаем данные при загрузке страницы
            setTimeout(() => applyFilters(), 1000);
        });
    </script>
</body>
</html>