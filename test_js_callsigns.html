<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест JavaScript для позывных</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Тест JavaScript для позывных LoTW</h1>
        
        <form id="testForm">
            <div class="mb-3">
                <label for="callsigns-container" class="form-label">Мои позывные в LoTW:</label>
                <div id="callsigns-container">
                    <div class="my-callsign-item mb-2">
                        <input type="text" class="form-control name-input callsign-input"
                               name="my_callsigns_names[]"
                               value="TEST123"
                               placeholder="Позывной"
                               autocomplete="off">
                        <button type="button" class="btn btn-outline-danger btn-sm"
                                onclick="removeCallsign(this)">
                            ✕
                        </button>
                    </div>
                    <div class="my-callsign-item mb-2">
                        <input type="text" class="form-control name-input callsign-input"
                               name="my_callsigns_names[]"
                               value="UA4LO/AM"
                               placeholder="Позывной"
                               autocomplete="off">
                        <button type="button" class="btn btn-outline-danger btn-sm"
                                onclick="removeCallsign(this)">
                            ✕
                        </button>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addCallsign()">
                    + Добавить позывной
                </button>
            </div>
            
            <input type="hidden" id="my_callsigns_json" name="my_callsigns_json">
            
            <button type="submit" class="btn btn-primary">Тест отправки</button>
        </form>
        
        <div id="results" class="mt-4">
            <h3>Результаты:</h3>
            <pre id="output"></pre>
        </div>
    </div>

    <script>
        console.log('=== Profile Edit JS Loaded ===');
        
        // ========== Callsign Management Functions ==========
        
        // Initialize handlers for existing callsign inputs
        function initCallsignInputs() {
            document.querySelectorAll('.callsign-input').forEach(input => {
                // Убираем существующие обработчики, чтобы избежать дублирования
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);
                
                // Добавляем новый обработчик
                newInput.addEventListener('input', function() {
                    this.value = this.value.toUpperCase().replace(/[^A-Z0-9\/]/g, '');
                });
            });
            
            console.log('Initialized callsign inputs:', document.querySelectorAll('.callsign-input').length);
        }

        // Add new callsign input
        window.addCallsign = function() {
            const container = document.getElementById('callsigns-container');
            const item = document.createElement('div');
            item.className = 'my-callsign-item mb-2';
            item.innerHTML = `
                <input type="text" class="form-control name-input callsign-input"
                       name="my_callsigns_names[]"
                       value=""
                       placeholder="Позывной"
                       autocomplete="off">
                <button type="button" class="btn btn-outline-danger btn-sm"
                        onclick="removeCallsign(this)">
                    ✕
                </button>
            `;
            container.appendChild(item);
            
            // Инициализируем обработчики для нового поля
            initCallsignInputs();
            
            console.log('Added new callsign input');
        };

        // Remove callsign input
        window.removeCallsign = function(button) {
            const container = document.getElementById('callsigns-container');
            const items = container.querySelectorAll('.my-callsign-item');
            
            if (items.length > 1) {
                // Удаляем элемент
                const item = button.closest('.my-callsign-item');
                item.remove();
                console.log('Removed callsign input, remaining:', items.length - 1);
            } else {
                // Если это последний элемент, просто очищаем его
                const item = button.closest('.my-callsign-item');
                const input = item.querySelector('input');
                input.value = '';
                console.log('Cleared last callsign input');
            }
        };
        
        // ========== Form Submit Handler ==========
        document.getElementById('testForm').addEventListener('submit', function(e) {
            e.preventDefault(); // Предотвращаем отправку формы
            
            console.log('=== DEBUG: Form Submit ===');
            console.log('Form submit triggered');
            
            const callsigns = [];
            const container = document.getElementById('callsigns-container');
            const items = container.querySelectorAll('.my-callsign-item');

            console.log('Found items:', items.length);
            
            items.forEach(function(item, index) {
                const input = item.querySelector('input[name="my_callsigns_names[]"]');
                if (input) {
                    const name = input.value.trim();
                    console.log(`Item ${index}: "${name}"`);
                    if (name) {
                        callsigns.push({
                            name: name.toUpperCase()
                        });
                    }
                }
            });

            console.log('Collected callsigns:', callsigns);
            
            const jsonField = document.getElementById('my_callsigns_json');
            if (jsonField) {
                const jsonValue = JSON.stringify(callsigns);
                jsonField.value = jsonValue;
                console.log('JSON field value set to:', jsonValue);
                
                // Дополнительная проверка
                console.log('JSON field after setting:', jsonField.value);
            } else {
                console.error('my_callsigns_json field not found!');
            }
            
            // Показываем результаты
            const output = document.getElementById('output');
            output.textContent = `
Собранные позывные: ${JSON.stringify(callsigns, null, 2)}
JSON поле: ${jsonField.value}
Проверка: ${jsonField.value === JSON.stringify(callsigns)}
            `;
            
            return false; // Предотвращаем отправку формы
        });

        // Initialize handlers when page loads
        initCallsignInputs();
    </script>
</body>
</html>