<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Callsigns Debug</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Тестирование позывных - Debug</h2>
        
        <div class="card">
            <div class="card-header">
                <h5>Тестовые данные</h5>
            </div>
            <div class="card-body">
                <p><strong>Имитация данных из Django:</strong></p>
                <pre id="django-data">[]</pre>
                
                <button onclick="loadDjangoData()" class="btn btn-primary">Загрузить данные из Django</button>
                <button onclick="addTestCallsign()" class="btn btn-success">Добавить тестовый позывной</button>
                <button onclick="saveData()" class="btn btn-warning">Сохранить данные</button>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5>Форма с позывными</h5>
            </div>
            <div class="card-body">
                <form id="test-form">
                    <input type="hidden" name="csrfmiddlewaretoken" value="test-token">
                    <input type="hidden" name="my_callsigns_json" id="my_callsigns_json" value="[]">
                    
                    <div id="callsigns-container">
                        <!-- Позывные будут добавляться здесь -->
                    </div>
                    
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addCallsign()">
                        <span>+</span> Добавить позывной
                    </button>
                </form>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5>Отладка</h5>
            </div>
            <div class="card-body">
                <div id="debug-output">
                    <h6>Логи:</h6>
                    <pre id="debug-log"></pre>
                </div>
                
                <div class="mt-3">
                    <h6>Текущие данные в форме:</h6>
                    <pre id="current-data"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        let debugLog = [];
        
        function log(message) {
            console.log(message);
            debugLog.push(new Date().toLocaleTimeString() + ': ' + message);
            document.getElementById('debug-log').textContent = debugLog.join('\n');
        }
        
        function loadDjangoData() {
            // Имитируем данные из Django template
            const djangoData = [
                {'name': 'TEST1'},
                {'name': 'TEST2'},
                {'name': 'TEST3/AM'}
            ];
            
            document.getElementById('django-data').textContent = JSON.stringify(djangoData, null, 2);
            
            // Загружаем данные в форму
            loadCallsignsFromData(djangoData);
            log('Загружены данные из Django: ' + JSON.stringify(djangoData));
        }
        
        function addTestCallsign() {
            const testCallsigns = [
                {'name': 'R3LO'},
                {'name': 'TEST1'},
                {'name': 'UA4LO'}
            ];
            
            const randomCallsign = testCallsigns[Math.floor(Math.random() * testCallsigns.length)];
            addCallsignInput(randomCallsign.name);
            log('Добавлен тестовый позывной: ' + randomCallsign.name);
        }
        
        function loadCallsignsFromData(data) {
            const container = document.getElementById('callsigns-container');
            container.innerHTML = '';
            
            if (data && data.length > 0) {
                data.forEach(function(callsignItem) {
                    const name = callsignItem.name || callsignItem;
                    addCallsignInput(name);
                });
            } else {
                addCallsignInput('');
            }
        }
        
        function addCallsignInput(value) {
            const container = document.getElementById('callsigns-container');
            const item = document.createElement('div');
            item.className = 'my-callsign-item';
            item.innerHTML = `
                <input type="text" class="form-control name-input callsign-input"
                       name="my_callsigns_names[]"
                       value="${value || ''}"
                       placeholder="Позывной"
                       autocomplete="off">
                <button type="button" class="btn btn-outline-danger btn-sm"
                        onclick="removeCallsign(this)">
                    ✕
                </button>
            `;
            container.appendChild(item);
            
            // Добавляем обработчик для автоматического перевода в верхний регистр
            const input = item.querySelector('.callsign-input');
            input.addEventListener('input', function() {
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9\/]/g, '');
                updateCurrentData();
            });
            
            updateCurrentData();
        }
        
        function addCallsign() {
            addCallsignInput('');
            log('Добавлено пустое поле позывного');
        }
        
        function removeCallsign(button) {
            const container = document.getElementById('callsigns-container');
            const item = button.closest('.my-callsign-item');
            item.remove();
            
            // Если элементов не осталось, добавляем новый пустой
            const remainingItems = container.querySelectorAll('.my-callsign-item');
            if (remainingItems.length === 0) {
                addCallsign();
            }
            
            updateCurrentData();
            log('Удалён позывной, осталось: ' + remainingItems.length);
        }
        
        function saveData() {
            const callsigns = [];
            const container = document.getElementById('callsigns-container');
            const items = container.querySelectorAll('.my-callsign-item');
            
            items.forEach(function(item) {
                const input = item.querySelector('input[name="my_callsigns_names[]"]');
                const name = input.value.trim();
                if (name) {
                    callsigns.push({
                        name: name.toUpperCase()
                    });
                }
            });
            
            const jsonField = document.getElementById('my_callsigns_json');
            jsonField.value = JSON.stringify(callsigns);
            
            log('Сохранены позывные: ' + JSON.stringify(callsigns));
            log('JSON поле: ' + jsonField.value);
            
            updateCurrentData();
            
            // Показываем данные, которые будут отправлены
            alert('Данные для отправки:\n' + JSON.stringify(callsigns, null, 2));
        }
        
        function updateCurrentData() {
            const callsigns = [];
            const container = document.getElementById('callsigns-container');
            const items = container.querySelectorAll('.my-callsign-item');
            
            items.forEach(function(item) {
                const input = item.querySelector('input[name="my_callsigns_names[]"]');
                const name = input.value.trim();
                if (name) {
                    callsigns.push({
                        name: name.toUpperCase()
                    });
                }
            });
            
            document.getElementById('current-data').textContent = JSON.stringify(callsigns, null, 2);
        }
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            log('Страница загружена');
            addCallsign(); // Добавляем одно пустое поле
        });
    </script>
    
    <style>
        .my-callsign-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .my-callsign-item input {
            flex: 1;
        }
    </style>
</body>
</html>