<!DOCTYPE html>
<html lang="ru">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è - TLog</title>
    <link rel="icon" href="{% static 'favicon.svg' %}" type="image/svg+xml">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .form-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
        }
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 2rem;
        }
        .callsign-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        .my-callsign-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .my-callsign-item input {
            border: none;
            background: transparent;
            font-weight: 500;
            color: #495057;
        }
        .my-callsign-item input:focus {
            outline: none;
        }
        .my-callsign-item input.name-input {
            flex: 1;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">üì° TLog - —Ç–≤–æ–π –ª–æ–≥</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link text-light me-3" href="/logbook/">
                    <span>üìì</span> Logbook
                </a>
                <a class="nav-link text-light me-3" href="/qth-loc.html" target="_blank">
                    <span>üó∫Ô∏è</span> Grid map
                </a>
                <a class="nav-link text-light me-3" href="/achievements/">
                    <span>üèÜ</span> –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                </a>
                <a class="nav-link text-light me-3" href="/dashboard/">
                    <span>üë§</span> {{ user.username }}
                </a>
                <a class="btn btn-outline-light btn-sm" href="/logout/">–í—ã–π—Ç–∏</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="main-container">
            <!-- Header -->
            <div class="page-header text-center">
                <h2><span>‚úèÔ∏è</span> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∏ –ø—Ä–æ—Ñ–∏–ª–µ–º –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å LoTW</h2>
                <p class="mb-0">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ARRL Logbook of the World</p>
            </div>

            <div class="p-4">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <form method="post" action="{% url 'profile_update' %}">
                    {% csrf_token %}

                    <div class="row">
                        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                        <div class="col-lg-6">
                            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
                            <div class="form-card mb-4">
                                <h5 class="section-title"><span>üîê</span> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h5>

                                <div class="mb-2">
                                    <strong>Username:</strong> {{ user.username }}
                                </div>
                                <div class="mb-2">
                                    <strong>Email:</strong> {{ user.email }}
                                </div>
                                <div class="mb-2">
                                    <strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> {{ user.date_joined|date:"d.m.Y" }}
                                </div>
                                <div class="mb-0">
                                    <strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥:</strong> {{ user.last_login|date:"d.m.Y H:i" }}
                                </div>
                            </div>

                            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ LoTW -->
                            <div class="form-card mb-4">
                                <h5 class="section-title"><span>üåê</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ LoTW</h5>
                                <p class="text-muted small">–£—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è ARRL Logbook of the World</p>

                                <div class="mb-3">
                                    <label class="form-label">–õ–æ–≥–∏–Ω (–ø–æ–∑—ã–≤–Ω–æ–π)</label>
                                    <input type="text" class="form-control" name="lotw_user"
                                           value="{{ profile.lotw_user|default:'' }}"
                                           placeholder="UA1ABC" maxlength="50">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                                    <input type="password" class="form-control" name="lotw_password"
                                           value="{{ profile.lotw_password|default:'' }}"
                                           placeholder="–ü–∞—Ä–æ–ª—å –æ—Ç LoTW" maxlength="100">
                                </div>

                                <div class="mb-0">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="lotw_chk_pass"
                                               id="lotw_chk_pass" {% if profile.lotw_chk_pass %}checked{% endif %}>
                                        <label class="form-check-label" for="lotw_chk_pass">
                                            –õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                        <div class="col-lg-6">
                            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                            <div class="form-card mb-4">
                                <h5 class="section-title"><span>üë§</span> –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>

                                <div class="mb-3">
                                    <label class="form-label">–ü–æ–∑—ã–≤–Ω–æ–π</label>
                                    <input type="text" class="form-control" name="callsign"
                                           value="{{ profile.callsign|default:'' }}"
                                           placeholder="UA1ABC" maxlength="20">
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">–ò–º—è</label>
                                        <input type="text" class="form-control" name="first_name"
                                               value="{{ profile.first_name|default:user.first_name }}"
                                               placeholder="–ò–≤–∞–Ω" maxlength="100">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">–§–∞–º–∏–ª–∏—è</label>
                                        <input type="text" class="form-control" name="last_name"
                                               value="{{ profile.last_name|default:user.last_name }}"
                                               placeholder="–ü–µ—Ç—Ä–æ–≤" maxlength="100">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">QTH (–º–µ—Å—Ç–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è)</label>
                                    <input type="text" class="form-control" name="qth"
                                           value="{{ profile.qth|default:'' }}"
                                           placeholder="–≥. –ú–æ—Å–∫–≤–∞, –†–æ—Å—Å–∏—è" maxlength="100">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">–ú–æ–π QTH –ª–æ–∫–∞—Ç–æ—Ä</label>
                                    <input type="text" class="form-control" name="my_gridsquare"
                                           value="{{ profile.my_gridsquare|default:'' }}"
                                           placeholder="KO85UU" maxlength="10">
                                    <div class="form-text">–ù–∞–ø—Ä–∏–º–µ—Ä: KO85UU –¥–ª—è –ú–æ—Å–∫–≤—ã</div>
                                </div>
                            </div>

                            <!-- –ú–æ–∏ –ø–æ–∑—ã–≤–Ω—ã–µ –≤ LoTW -->
                            <div class="form-card mb-4">
                                <h5 class="section-title"><span>üì°</span> –ú–æ–∏ –ø–æ–∑—ã–≤–Ω—ã–µ –≤ LoTW</h5>
                                <p class="text-muted small">–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ –ø–æ–∑—ã–≤–Ω—ã–µ (–¥–µ–π—Å—Ç–≤—É—é—â–∏–µ, –±—ã–≤—à–∏–µ, —Å–ø–µ—Ü–ø–æ–∑—ã–≤–Ω—ã–µ) –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å LoTW</p>

                                <div id="callsigns-container">
                                    {% if profile.my_callsigns %}
                                        {% for callsign_item in profile.my_callsigns %}
                                            <div class="my-callsign-item">
                                                {% if callsign_item.name %}
                                                    <input type="text" class="form-control name-input"
                                                           name="my_callsigns_names[]"
                                                           value="{{ callsign_item.name }}"
                                                           placeholder="–ü–æ–∑—ã–≤–Ω–æ–π">
                                                    <input type="text" class="form-control name-input"
                                                           name="my_callsigns_types[]"
                                                           value="{{ callsign_item.type|default:'' }}"
                                                           placeholder="–¢–∏–ø (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                                                {% else %}
                                                    <input type="text" class="form-control name-input"
                                                           name="my_callsigns_names[]"
                                                           value="{{ callsign_item }}"
                                                           placeholder="–ü–æ–∑—ã–≤–Ω–æ–π">
                                                    <input type="text" class="form-control name-input"
                                                           name="my_callsigns_types[]"
                                                           value=""
                                                           placeholder="–¢–∏–ø (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                                                {% endif %}
                                                <button type="button" class="btn btn-outline-danger btn-sm"
                                                        onclick="removeCallsign(this)">
                                                    ‚úï
                                                </button>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>

                                <button type="button" class="btn btn-outline-primary btn-sm"
                                        onclick="addCallsign()">
                                    <span>+</span> –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑—ã–≤–Ω–æ–π
                                </button>

                                <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è JSON -->
                                <input type="hidden" name="my_callsigns_json" id="my_callsigns_json" value="[]">
                            </div>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ -->
                    <div class="d-flex gap-3 mt-4">
                        <button type="submit" class="btn btn-success btn-lg px-5">
                            <span class="me-1">üíæ</span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                        <a href="/dashboard/" class="btn btn-outline-secondary btn-lg px-5">
                            <span class="me-1">‚úñ</span>–û—Ç–º–µ–Ω–∞
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .section-title {
            color: #667eea;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
    </style>

    <script>
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–∑—ã–≤–Ω–æ–≥–æ
        function addCallsign() {
            const container = document.getElementById('callsigns-container');
            const item = document.createElement('div');
            item.className = 'my-callsign-item';
            item.innerHTML = `
                <input type="text" class="form-control name-input"
                       name="my_callsigns_names[]"
                       placeholder="–ü–æ–∑—ã–≤–Ω–æ–π">
                <input type="text" class="form-control name-input"
                       name="my_callsigns_types[]"
                       placeholder="–¢–∏–ø (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                <button type="button" class="btn btn-outline-danger btn-sm"
                        onclick="removeCallsign(this)">
                    ‚úï
                </button>
            `;
            container.appendChild(item);
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–∑—ã–≤–Ω–æ–≥–æ
        function removeCallsign(button) {
            const container = document.getElementById('callsigns-container');
            const items = container.querySelectorAll('.my-callsign-item');
            if (items.length > 1) {
                button.closest('.my-callsign-item').remove();
            } else {
                // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç, –ø—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º –ø–æ–ª—è
                const item = button.closest('.my-callsign-item');
                item.querySelectorAll('input').forEach(input => input.value = '');
            }
        }

        // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ JSON –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
        document.querySelector('form').addEventListener('submit', function(e) {
            const callsigns = [];
            const container = document.getElementById('callsigns-container');
            const items = container.querySelectorAll('.my-callsign-item');

            items.forEach(item => {
                const name = item.querySelector('input[name="my_callsigns_names[]"]').value.trim();
                if (name) {
                    callsigns.push({
                        name: name,
                        type: item.querySelector('input[name="my_callsigns_types[]"]').value.trim()
                    });
                }
            });

            document.getElementById('my_callsigns_json').value = JSON.stringify(callsigns);
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ QTH –ª–æ–∫–∞—Ç–æ—Ä–∞ –≤ –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
        document.querySelector('input[name="my_gridsquare"]').addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    </script>
</body>
</html>