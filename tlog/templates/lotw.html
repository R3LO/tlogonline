{% extends 'lotw_base.html' %}
{% load i18n %}
{% load static %}

{% block lotw_content %}
<div class="row">
    <div class="col-lg-9">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ LoTW -->
        <div class="card mb-4 fade-in">
            <div class="card-header">
                <h5 class="mb-0"><span>üìã</span> {% trans "Recent QSOs with LoTW" %}</h5>
            </div>
            
            <!-- –§–∏–ª—å—Ç—Ä—ã –¥–ª—è LoTW QSO - —Ä–∞–∑–º–µ—â–µ–Ω—ã –≤–Ω–µ card-body -->
            <div class="card-body pt-3">
                <div class="filter-card mb-4">
                    <h5 class="section-title"><span>üîç</span> {% trans "–§–∏–ª—å—Ç—Ä—ã" %}</h5>
                    <form class="filter-controls">
                        {% csrf_token %}
                        <div class="filter-group">
                            <label class="form-label small mb-1">{% trans "–ú–æ–π –ø–æ–∑—ã–≤–Ω–æ–π" %}</label>
                            <select class="form-select form-select-sm" name="my_callsign">
                                <option value="">{% trans "–í—Å–µ" %}</option>
                                {% for my_call in my_callsigns %}
                                    <option value="{{ my_call }}" {% if my_call == my_callsign_filter %}selected{% endif %}>{{ my_call }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="form-label small mb-1">{% trans "–ü–æ–∑—ã–≤–Ω–æ–π" %}</label>
                            <input type="text" class="form-control form-control-sm" name="search_callsign" value="{{ search_callsign }}" placeholder="{% trans '–ü–æ–∑—ã–≤–Ω–æ–π' %}">
                        </div>
                        <div class="filter-group">
                            <label class="form-label small mb-1">QTH –ª–æ–∫–∞—Ç–æ—Ä</label>
                            <input type="text" class="form-control form-control-sm" name="search_qth" value="{{ search_qth }}" placeholder="QTH –ª–æ–∫–∞—Ç–æ—Ä">
                        </div>
                        <div class="filter-group">
                            <label class="form-label small mb-1">{% trans "–î–∏–∞–ø–∞–∑–æ–Ω" %}</label>
                            <select class="form-select form-select-sm" name="band">
                                <option value="">{% trans "–í—Å–µ" %}</option>
                                {% for band in available_bands %}
                                    <option value="{{ band }}" {% if band == band_filter %}selected{% endif %}>{{ band }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="form-label small mb-1">{% trans "–í–∏–¥ —Å–≤—è–∑–∏" %}</label>
                            <select class="form-select form-select-sm" name="mode">
                                <option value="">{% trans "–í—Å–µ" %}</option>
                                {% for mode in available_modes %}
                                    <option value="{{ mode }}" {% if mode == mode_filter %}selected{% endif %}>{{ mode }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="form-label small mb-1">{% trans "–°–ø—É—Ç–Ω–∏–∫" %}</label>
                            <select class="form-select form-select-sm" name="sat_name">
                                <option value="">{% trans "–í—Å–µ" %}</option>
                                {% for sat in available_sat_names %}
                                    <option value="{{ sat }}" {% if sat == sat_name_filter %}selected{% endif %}>{{ sat }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="filter-actions">
                            <button type="button" class="btn btn-secondary btn-sm" id="resetFilters" title="{% trans '–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã' %}">
                                <span>‚ùå</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card-body pt-0">
                
                <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ QSO —Å LoTW –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º -->                
                {% if recent_lotw_qso %}
                <div class="qso-table-container">
                    <div class="lotw-qso-table">
                        <div class="table-responsive">
                            <table class="table table-striped qso-table lotw-table">
                                <thead class="qso-table-header">
                                    <tr>
                                        <th class="col-date"><span>üìÖ</span> {% trans "Date" %}</th>
                                        <th class="col-time"><span>üïê</span> {% trans "Time" %}</th>
                                        <th class="col-my-callsign"><span>üë§</span> {% trans "My Call" %}</th>
                                        <th class="col-callsign"><span>üì°</span> {% trans "Callsign" %}</th>
                                        <th class="col-band"><span>üì∂</span> {% trans "Band" %}</th>
                                        <th class="col-mode"><span>üìü</span> {% trans "Mode" %}</th>
                                        <th class="col-qth"><span>üìç</span> QTH</th>
                                        <th class="col-r150s"><span>üèÜ</span> –†-150-–°</th>
                                        <th class="col-region"><span>üá∑üá∫</span> RU</th>
                                        <th class="col-propsat"><span>üì°</span> PROP/SAT</th>
                                        <th class="col-lotw-date"><span>üìß</span> LoTW</th>
                                        <th class="col-lotw"><span>LoTW</span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for qso in recent_lotw_qso %}
                                    <tr>
                                        <td class="col-date" data-label="üìÖ {% trans "Date" %}">
                                            <small>{{ qso.date|date:"d.m.Y" }}</small>
                                        </td>
                                        <td class="col-time" data-label="üïê {% trans "Time" %}">
                                            <small>{{ qso.time|date:"H:i" }}</small>
                                        </td>
                                        <td class="col-my-callsign" data-label="üë§ {% trans "My Call" %}">
                                            <small>{{ qso.my_callsign|default:qso.user.username }}</small>
                                        </td>
                                        <td class="col-callsign" data-label="üì° {% trans "Callsign" %}">
                                            <span class="callsign-badge">{{ qso.callsign }}</span>
                                        </td>
                                        <td class="col-band" data-label="üì∂ {% trans "Band" %}">
                                            {% if qso.band %}
                                                <span class="band-badge">{{ qso.band }}</span>
                                            {% elif qso.frequency %}
                                                {% with band=qso.frequency|default_if_none:"" %}
                                                    <span class="band-badge">{{ band }}</span>
                                                    <br><small class="text-muted">{{ qso.frequency }} MHz</small>
                                                {% endwith %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="col-mode" data-label="üìü {% trans "Mode" %}">
                                            <span class="mode-badge">{{ qso.mode }}</span>
                                        </td>
                                        <td class="col-qth" data-label="üìç QTH">
                                            {% if qso.gridsquare %}
                                                <small>{{ qso.gridsquare }}</small>
                                            {% else %}
                                                <small class="text-muted">-</small>
                                            {% endif %}
                                        </td>
                                        <td class="col-r150s" data-label="üèÜ –†-150-–°">
                                            {% if qso.r150s %}
                                                {{ qso.r150s }}
                                            {% else %}
                                                <small class="text-muted">-</small>
                                            {% endif %}
                                        </td>
                                        <td class="col-region" data-label="üá∑üá∫ RU">
                                            {% if qso.ru_region %}
                                                <span class="region-badge" title="{{ qso.ru_region }}">{{ qso.ru_region }}</span>
                                            {% else %}
                                                <small class="text-muted">-</small>
                                            {% endif %}
                                        </td>
                                        <td class="col-propsat" data-label="üì° PROP/SAT">
                                            {% if qso.prop_mode or qso.sat_name %}
                                                <small>
                                                    {% if qso.prop_mode %}{{ qso.prop_mode }}{% endif %}
                                                    {% if qso.prop_mode and qso.sat_name %} / {% endif %}
                                                    {% if qso.sat_name %}{{ qso.sat_name }}{% endif %}
                                                </small>
                                            {% else %}
                                                <small class="text-muted">-</small>
                                            {% endif %}
                                        </td>
                                        <td class="col-lotw-date" data-label="üìß LoTW">
                                            <span class="lotw-date-badge">{{ qso.app_lotw_rxqsl|date:"d.m.Y" }}</span>
                                        </td>
                                        <td class="col-lotw" data-label="LoTW">
                                            <span class="lotw-confirmed" title="{% trans 'LoTW Confirmed' %}">‚úÖ</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è QSO —Å LoTW -->
                <div class="pagination-info text-center text-muted mb-2">
                    <small>
                        –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ current_page }} –∏–∑ {{ total_pages }} 
                        (<span data-current-count>{{ recent_lotw_qso|length }}</span> –∏–∑ <span data-total-count>{{ lotw_confirmed_count }}</span> –∑–∞–ø–∏—Å–µ–π)
                    </small>
                </div>
                <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º QSO" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if current_page > 1 %}
                            <li class="page-item">
                                <a class="page-link btn-link" href="#" data-page="{{ current_page|add:'-1' }}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
                            </li>
                        {% endif %}

                        {% load custom_filters %}
                        {% paginate_numbers current_page total_pages 3 as page_numbers %}
                        {% for page_num in page_numbers %}
                            {% if page_num == '...' %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% elif page_num == current_page %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% else %}
                                <li class="page-item">
                                    <a class="page-link btn-link" href="#" data-page="{{ page_num }}">{{ page_num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if current_page < total_pages %}
                            <li class="page-item">
                                <a class="page-link btn-link" href="#" data-page="{{ current_page|add:'1' }}">–°–ª–µ–¥—É—é—â–∞—è</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                
                <div class="text-center mt-3">
                    {% if lotw_confirmed_count > 20 %}
                    <div class="text-muted mb-2">
                        <small>
                            –ü–æ–∫–∞–∑–∞–Ω–æ –ø–µ—Ä–≤—ã–µ {{ recent_lotw_qso|length }} –∏–∑ {{ lotw_confirmed_count }} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö QSO
                        </small>
                    </div>
                    {% endif %}
                    <a href="/logbook/?lotw=Y" class="btn btn-outline-primary btn-sm">
                        <span>üìã</span> {% trans "View All LoTW QSOs" %}
                    </a>
                </div>
                
                {% else %}
                <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ QSO -->
                <div class="qso-table-empty">
                    <div class="qso-table-empty-icon">üì°</div>
                    <div class="qso-table-empty-title">{% trans "No LoTW QSOs Yet" %}</div>
                    <div class="qso-table-empty-text">
                        {% trans "Start logging your QSOs to see them here with LoTW confirmation status." %}
                    </div>
                    <a href="/logbook/" class="btn btn-primary">
                        <span>üìù</span> {% trans "Add Your First QSO" %}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
       
    </div>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="col-lg-3">
        <!-- –°—Ç–∞—Ç—É—Å LoTW -->
        <div class="card mb-4 fade-in lotw-status">
            <div class="card-header">
                <h6 class="mb-0"><span>üìä</span> {% trans "Your LoTW Status" %}</h6>
            </div>
            <div class="card-body">
                {% if profile.lotw_user and profile.lotw_password %}
                    {% if profile.lotw_chk_pass %}
                        <div class="alert alert-success py-2">
                            <span class="me-2">‚úÖ</span>
                            <strong>{% trans "LoTW Connected" %}</strong>
                        </div>
                        <p class="mb-2">
                            <span class="me-2">üë§</span>
                            <small>{% trans "Username:" %} <strong>{{ profile.lotw_user }}</strong></small>
                        </p>
                        {% if profile.lotw_lastsync %}
                            <p class="mb-0">
                                <span class="me-2">üìÖ</span>
                                <small>{% trans "Last sync:" %} <strong>{{ profile.lotw_lastsync|date:"d.m.Y H:i" }}</strong></small>
                            </p>
                        {% else %}
                            <p class="mb-0 text-muted">
                                <span class="me-2">‚ùå</span>
                                <small>{% trans "No sync performed yet" %}</small>
                            </p>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-warning py-2">
                            <span class="me-2">‚ö†Ô∏è</span>
                            <strong>{% trans "LoTW Authentication Failed" %}</strong>
                        </div>
                        <p class="mb-0 text-muted">
                            <small>{% trans "Please check your LoTW login credentials" %}</small>
                        </p>
                    {% endif %}
                {% else %}
                    <div class="alert alert-info py-2">
                        <span class="me-2">‚ÑπÔ∏è</span>
                        <strong>{% trans "LoTW Not Configured" %}</strong>
                    </div>
                    <p class="mb-0 text-muted">
                        <small>{% trans "Add your LoTW credentials in profile settings" %}</small>
                    </p>
                {% endif %}
            </div>
        </div>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="card mb-4 fade-in quick-actions">
            <div class="card-header">
                <h6 class="mb-0"><span>‚ö°</span> {% trans "Quick Actions" %}</h6>
            </div>
            <div class="card-body">
                <a href="/dashboard/profile/" class="btn btn-primary w-100 mb-2">
                    <span>‚öôÔ∏è</span> {% trans "Configure LoTW" %}
                </a>
                <a href="/dashboard/" class="btn btn-outline-primary w-100 mb-2">
                    <span>üìä</span> {% trans "View Dashboard" %}
                </a>
                <a href="/logbook/" class="btn btn-outline-secondary w-100">
                    <span>üìã</span> {% trans "Manage Logbook" %}
                </a>
            </div>
        </div>

        <!-- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã -->
        <div class="card mb-4 fade-in">
            <div class="card-header">
                <h6 class="mb-0"><span>üíª</span> {% trans "Supported Software" %}</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2"><span class="text-primary">üì±</span> <small>{% trans "TQSL (ARRL's official LoTW software)" %}</small></li>
                    <li class="mb-2"><span class="text-primary">üì±</span> <small>{% trans "DXToolbox" %}</small></li>
                    <li class="mb-2"><span class="text-primary">üì±</span> <small>{% trans "QSO Log" %}</small></li>
                    <li class="mb-2"><span class="text-primary">üì±</span> <small>{% trans "LoTW Mobile" %}</small></li>
                    <li class="mb-0"><span class="text-primary">üì±</span> <small>{% trans "And many more..." %}</small></li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
