<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>TLog - Grid Map</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
</head>
<body>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

    <style type="text/css">
        #mouse-location {
            display: table;
            width: 110px;
            margin: 10px;
            padding: 5px;
            border: none;
            border-radius: 3px;
            font-size: 12px;
            text-align: center;
            color: #222;
            background: #fff;
        }
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    </style>

    <div id='map'></div>
    <pre id="info"></pre>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoianVzdGlubSIsImEiOiJjamo4Mmd2dDcwaDFnM3BwMjd3cTAwcmdvIn0.fHyEJg65CtU3qBiV6fOEag';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/satellite-streets-v9',
    projection: 'globe',
    center: [0, 0],
    zoom: 1
});

class MouseLocationControl {
    onAdd(map) {
        this.map = map;
        this.container = document.createElement('div');
        this.container.id = 'mouse-location';
        this.container.className = 'mapboxgl-ctrl';
        this.container.textContent = '0.0000,0.0000\nAA00AA';
        return this.container;
    }
    
    getDisplayDigits() {
        return 4;
    }
    
    onRemove() {
        this.container.parentNode.removeChild(this.container);
        this.map = undefined;
    }
    
    onMouseMove(e) {
        // Исправлено: вызываем getZoom() от map, а не от this
        var zoom = this.map.getZoom();
        var precision = Math.min(Math.max(Math.floor(zoom) / 4, 2), 5);
        document.getElementById('mouse-location').innerHTML =
            `${e.lngLat.lat.toFixed(precision)},${e.lngLat.lng.toFixed(precision)}` +
            '<br />' +
            `${getLocator(e.lngLat.lng, e.lngLat.lat, precision)}`;
    }
    
    onClick(e) {
        if (navigator.clipboard != null) {
            navigator.clipboard.writeText(getLocator(e.lngLat.lng, e.lngLat.lat));
        }
    }
};

function divmod(a, b) {
    var div = Math.floor(a / b);
    var rem = a % b;
    return [div, rem];
};

// Return maidenhead string for the lat lon tuple at the specified precision
function getLocator(lon, lat, precision = 3) {
    var A = "A".charCodeAt(0);
    var a = divmod(lon + 180, 20);
    var b = divmod(lat + 90, 10);
    var astring = String.fromCharCode(A + Math.floor(a[0])) + String.fromCharCode(A + Math.floor(b[0]));
    lon = a[1] / 2.0;
    lat = b[1];
    var i = 1;
    
    while (i < precision) {
        i += 1;
        a = divmod(lon, 1);
        b = divmod(lat, 1);
        
        if (0 == (i % 2)) {
            astring += Math.floor(a[0]) + '' + Math.floor(b[0]);
            lon = 24 * a[1];
            lat = 24 * b[1];
        } else {
            astring += String.fromCharCode(A + Math.floor(a[0])) + String.fromCharCode(A + Math.floor(b[0]));
            lon = 10 * a[1];
            lat = 10 * b[1];
        }
    }
    return astring;
};

// Вспомогательная функция для создания геометрии квадрата
function createSquareFeature(lon, lat, width, height, id) {
    return {
        "type": "Feature",
        "id": id || "grid-cell",
        "geometry": {
            "type": "Polygon",
            "coordinates": [[
                [lon, lat],
                [lon, lat + height],
                [lon + width, lat + height],
                [lon + width, lat],
                [lon, lat]
            ]]
        },
        "properties": {}
    };
}

// Вспомогательная функция для создания метки
function createLabelFeature(lon, lat, text) {
    return {
        "type": "Feature",
        "id": text,
        "geometry": {
            "type": "Point",
            "coordinates": [lon, lat]
        },
        "properties": { "name": text }
    };
}

// Создаем фиксированные данные для первых двух уровней (имитация JSON файлов)
function createLevel1Grid() {
    const features = [];
    const labels = [];
    
    // Уровень 1: 20°x10° поля (Maidenhead Field)
    for (let lon = -180; lon < 180; lon += 20) {
        for (let lat = -90; lat < 90; lat += 10) {
            features.push(createSquareFeature(lon, lat, 20, 10, `L1-${lon}-${lat}`));
            
            // Центр ячейки для подписи
            const centerLon = lon + 10;
            const centerLat = lat + 5;
            const locator = getLocator(centerLon, centerLat, 1);
            labels.push(createLabelFeature(centerLon, centerLat, locator));
        }
    }
    
    return { features, labels };
}

function createLevel2Grid() {
    const features = [];
    const labels = [];
    
    // Уровень 2: 2°x1° квадраты (Maidenhead Square)
    for (let lon = -180; lon < 180; lon += 2) {
        for (let lat = -90; lat < 90; lat += 1) {
            features.push(createSquareFeature(lon, lat, 2, 1, `L2-${lon}-${lat}`));
            
            // Центр ячейки для подписи
            const centerLon = lon + 1;
            const centerLat = lat + 0.5;
            const locator = getLocator(centerLon, centerLat, 2);
            labels.push(createLabelFeature(centerLon, centerLat, locator));
        }
    }
    
    return { features, labels };
}

// Создаем данные для первых двух уровней
const level1Data = createLevel1Grid();
const level2Data = createLevel2Grid();

// Данные для динамического уровня 3
const featuredata = { type: 'FeatureCollection', features: [] };
const labeldata = { type: 'FeatureCollection', features: [] };

map.on('load', function () {
    map.setFog({});
    
    // Добавление геокодера
    map.addControl(new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl
    }));
    
    const mouseLocationControl = new MouseLocationControl();

    map.addControl(new mapboxgl.NavigationControl());
    map.addControl(new mapboxgl.ScaleControl());
    map.addControl(mouseLocationControl, 'bottom-right');

    // Исправленные обработчики событий
    map.on('mousemove', function(e) {
        mouseLocationControl.onMouseMove(e);
    });
    
    map.on('click', function(e) {
        mouseLocationControl.onClick(e);
    });

    // Уровень 1: 20°x10° (показывается при zoom 0-5)
    map.addSource('maiden-1', {
        type: 'geojson',
        data: {
            type: 'FeatureCollection',
            features: level1Data.features
        }
    });
    
    map.addLayer({
        'id': 'maiden-1-fill',
        'type': 'fill',
        'source': 'maiden-1',
        'layout': {},
        'paint': {
            'fill-color': '#888',
            'fill-opacity': 0.4
        },
        'minzoom': 0,
        'maxzoom': 5
    });
    
    map.addLayer({
        'id': 'maiden-1-line',
        'type': 'line',
        'source': 'maiden-1',
        'layout': {},
        'paint': {
            'line-color': '#ddd',
            'line-width': 2,
            'line-opacity': 0.6
        },
        'minzoom': 0,
        'maxzoom': 5
    });
    
    map.addSource('maiden-1-label', {
        type: 'geojson',
        data: {
            type: 'FeatureCollection',
            features: level1Data.labels
        }
    });
    
    map.addLayer({
        'id': 'maiden-1-label-layer',
        'source': 'maiden-1-label',
        'type': 'symbol',
        "layout": {
            "text-field": "{name}",
            "symbol-placement": "point",
            "symbol-avoid-edges": true,
            "text-max-angle": 30,
            "text-size": 14
        },
        "paint": {
            "text-color": 'white',
            "text-halo-color": "black",
            "text-halo-width": 2,
            "text-halo-blur": 1
        },
        'minzoom': 0,
        'maxzoom': 5
    });

    // Уровень 2: 2°x1° (показывается при zoom 5-7)
    map.addSource('maiden-2', {
        type: 'geojson',
        data: {
            type: 'FeatureCollection',
            features: level2Data.features
        }
    });
    
    map.addLayer({
        'id': 'maiden-2-fill',
        'type': 'fill',
        'source': 'maiden-2',
        'layout': {},
        'paint': {
            'fill-color': '#888',
            'fill-opacity': 0.4
        },
        'minzoom': 5,
        'maxzoom': 7
    });
    
    map.addLayer({
        'id': 'maiden-2-line',
        'type': 'line',
        'source': 'maiden-2',
        'layout': {},
        'paint': {
            'line-color': '#ddd',
            'line-width': 2,
            'line-opacity': 0.6
        },
        'minzoom': 5,
        'maxzoom': 7
    });
    
    map.addSource('maiden-2-label', {
        type: 'geojson',
        data: {
            type: 'FeatureCollection',
            features: level2Data.labels
        }
    });
    
    map.addLayer({
        'id': 'maiden-2-label-layer',
        'source': 'maiden-2-label',
        'type': 'symbol',
        "layout": {
            "text-field": "{name}",
            "symbol-placement": "point",
            "symbol-avoid-edges": true,
            "text-max-angle": 30,
            "text-size": 14
        },
        "paint": {
            "text-color": 'white',
            "text-halo-color": "black",
            "text-halo-width": 2,
            "text-halo-blur": 1
        },
        'minzoom': 5,
        'maxzoom': 7
    });

    // Динамический уровень 3: 5'x2.5' (показывается при zoom >= 7)
    map.addSource('maiden-3-fill', { type: 'geojson', data: featuredata });
    map.addLayer({
        'id': 'maiden-3-fill',
        'type': 'fill',
        'source': 'maiden-3-fill',
        'layout': {},
        'paint': {
            'fill-color': '#888',
            'fill-opacity': 0.4
        },
        'minzoom': 7
    });
    
    map.addSource('maiden-3-line', { type: 'geojson', data: featuredata });
    map.addLayer({
        'id': 'maiden-3-line',
        'type': 'line',
        'source': 'maiden-3-line',
        'layout': {},
        'paint': {
            'line-color': '#ddd',
            'line-width': 2,
            'line-opacity': 0.6
        },
        'minzoom': 7
    });
    
    map.addSource('maiden-3-label', { type: 'geojson', data: labeldata });
    map.addLayer({
        'id': 'maiden-3-label',
        'source': 'maiden-3-label',
        'type': 'symbol',
        "layout": {
            "text-field": "{name}",
            "symbol-placement": "point",
            "symbol-avoid-edges": true,
            "text-max-angle": 30,
            "text-size": 14
        },
        "paint": {
            "text-color": 'white',
            "text-halo-color": "black",
            "text-halo-width": 2,
            "text-halo-blur": 1
        },
        'minzoom': 7
    });
    
    // Инициализируем сетку для текущего вида
    updateDynamicGrid();
});

// Исправленная функция обновления динамической сетки (уровень 3+)
function updateDynamicGrid() {
    var zoom = map.getZoom();
    
    // Только для zoom >= 7 (уровень 3 и выше)
    if (zoom < 7) return;
    
    // console.log removed
    
    // Правильные массивы для системы Maidenhead
    var d3 = new Array(
        20,      // zoom 0: Field (20°x10°)
        10,      // zoom 1
        10,      // zoom 2  
        10,      // zoom 3
        10,      // zoom 4
        10,      // zoom 5
        1,       // zoom 6: Square (2°x1°)
        1,       // zoom 7: Subsquare start (5'x2.5')
        1,       // zoom 8
        1,       // zoom 9
        1/24,    // zoom 10: 2.5' precision
        1/24,    // zoom 11
        1/24,    // zoom 12
        1/24,    // zoom 13
        1/24,    // zoom 14
        1/240,   // zoom 15: Extended (30"x15")
        1/240,   // zoom 16
        1/240,   // zoom 17
        1/240/24, // zoom 18: High precision
        1/240/24, // zoom 19
        1/240/24  // zoom 20
    );
    
    var d4 = new Array(
        0,  // zoom 0
        1,  // zoom 1: Field
        1,  // zoom 2
        1,  // zoom 3
        1,  // zoom 4
        1,  // zoom 5
        2,  // zoom 6: Square
        2,  // zoom 7: Subsquare start
        2,  // zoom 8
        2,  // zoom 9
        3,  // zoom 10: Subsquare
        3,  // zoom 11
        3,  // zoom 12
        3,  // zoom 13
        3,  // zoom 14
        4,  // zoom 15: Extended
        4,  // zoom 16
        4,  // zoom 17
        5,  // zoom 18: High precision
        5,  // zoom 19
        5   // zoom 20
    );
    
    var bounds = map.getBounds();
    var zoomIndex = Math.min(Math.floor(zoom), d3.length - 1);
    var unit = d3[zoomIndex];
    var precision = d4[zoomIndex];
    
    var w = bounds.getWest();
    var e = bounds.getEast();
    var n = bounds.getNorth();
    var s = bounds.getSouth();
    
    // Ограничиваем широту для системы Maidenhead
    if (n > 85) n = 85;
    if (s < -85) s = -85;
    
    // Выравнивание по сетке
    var left = Math.floor(w / (unit * 2)) * (unit * 2);
    var right = Math.ceil(e / (unit * 2)) * (unit * 2);
    var top = Math.ceil(n / unit) * unit;
    var bottom = Math.floor(s / unit) * unit;
    
    // Очищаем старые данные
    featuredata.features = [];
    labeldata.features = [];
    
    // Генерируем новые ячейки
    for (var lon = left; lon < right; lon += (unit * 2)) {
        for (var lat = bottom; lat < top; lat += unit) {
            let l = lon;
            let r = lon + (unit * 2);
            let b = lat;
            let t = lat + unit;
            
            // Создаем полигон ячейки
            let feature = {
                "type": "Feature",
                "geometry": {
                    "type": "Polygon",
                    "coordinates": [[
                        [l, b],
                        [l, t],
                        [r, t],
                        [r, b],
                        [l, b]
                    ]]
                },
                "properties": {
                    "precision": precision
                }
            };
            featuredata.features.push(feature);
            
            // Создаем метку
            let labelcoords = [(l + r) / 2, (b + t) / 2];
            let locator = getLocator(labelcoords[0], labelcoords[1], precision);
            
            let label = {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": labelcoords
                },
                "properties": { "name": locator }
            };
            labeldata.features.push(label);
        }
    }
    
    // Обновляем источники данных
    if (map.getSource('maiden-3-fill')) {
        map.getSource('maiden-3-fill').setData(featuredata);
        map.getSource('maiden-3-line').setData(featuredata);
        map.getSource('maiden-3-label').setData(labeldata);
    }
}

// Обработчики событий для обновления сетки
map.on('moveend', updateDynamicGrid);
map.on('zoomend', updateDynamicGrid);

// Исправленная обработка события loaded
map.on('load', function() {
    setTimeout(function() {
        map.resize();
    }, 100);
});

</script>
</body>
</html>