<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест загрузки ADIF</title>
</head>
<body>
    <h1>Тест загрузки ADIF файла</h1>
    
    <div>
        <label for="username">Логин:</label>
        <input type="text" id="username" value="testuser">
    </div>
    
    <div>
        <label for="password">Пароль:</label>
        <input type="password" id="password" value="testpass123">
    </div>
    
    <button onclick="login()">Войти</button>
    
    <div style="margin-top: 20px;">
        <input type="file" id="adifFile" accept=".adi,.adif">
        <button onclick="uploadFile()">Загрузить ADIF</button>
    </div>
    
    <div id="result" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;"></div>

    <script>
        let authToken = null;

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/api/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('result').innerHTML = 
                        '<div style="color: green;">Вход выполнен успешно!</div>';
                    // Сохраняем токен сессии
                    authToken = true;
                } else {
                    document.getElementById('result').innerHTML = 
                        `<div style="color: red;">Ошибка: ${result.error || 'Неизвестная ошибка'}</div>`;
                }
            } catch (error) {
                document.getElementById('result').innerHTML = 
                    `<div style="color: red;">Ошибка сети: ${error.message}</div>`;
            }
        }

        async function uploadFile() {
            if (!authToken) {
                document.getElementById('result').innerHTML = 
                    '<div style="color: red;">Сначала войдите в систему!</div>';
                return;
            }
            
            const fileInput = document.getElementById('adifFile');
            const file = fileInput.files[0];
            
            if (!file) {
                document.getElementById('result').innerHTML = 
                    '<div style="color: red;">Выберите файл для загрузки!</div>';
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('filename', file.name);
            
            try {
                const response = await fetch('/api/adif-uploads/', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('result').innerHTML = 
                        `<div style="color: green;">
                            Файл загружен успешно!<br>
                            ID: ${result.id}<br>
                            Имя файла: ${result.filename}<br>
                            Загружен: ${result.uploaded_at}<br>
                            Обработан: ${result.processed}<br>
                            Количество QSO: ${result.qso_count}<br>
                            ${result.error_message ? 'Ошибки: ' + result.error_message : ''}
                        </div>`;
                } else {
                    document.getElementById('result').innerHTML = 
                        `<div style="color: red;">
                            Ошибка: ${result.error || 'Неизвестная ошибка'}<br>
                            ${result.details ? 'Детали: ' + JSON.stringify(result.details) : ''}
                        </div>`;
                }
            } catch (error) {
                document.getElementById('result').innerHTML = 
                    `<div style="color: red;">
                        Ошибка сети: ${error.message}<br>
                        Это может означать, что сервер возвращает HTML вместо JSON
                    </div>`;
            }
        }
    </script>
</body>
</html>