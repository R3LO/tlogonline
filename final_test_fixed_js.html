<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ JavaScript</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>üîß –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ JavaScript</h1>
        
        <div class="alert alert-info">
            <h4>–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞:</h4>
            <ul>
                <li>‚ùå –ü–æ–∑—ã–≤–Ω—ã–µ LoTW –Ω–µ –ø–æ–¥–≥—Ä—É–∂–∞–ª–∏—Å—å –≤ —Ñ–æ—Ä–º—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</li>
                <li>‚ùå JavaScript –∫–æ–¥ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏</li>
                <li>‚ùå –î–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ —Ö—Ä–∞–Ω–∏–ª–∏—Å—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON, –Ω–æ JavaScript –Ω–µ –ø–∞—Ä—Å–∏–ª –∏—Ö</li>
            </ul>
            
            <h4>–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:</h4>
            <ul>
                <li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è loadProfileData() –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏</li>
                <li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫, JSON)</li>
                <li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞</li>
                <li>‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ—Ç–ª–∞–¥–∫–∞ —Å console.log</li>
            </ul>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <h3>üìä –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ:</h3>
                <div class="card">
                    <div class="card-body">
                        <pre id="databaseInfo" style="font-size: 12px;"></pre>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <h3>üîÑ –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:</h3>
                <button class="btn btn-primary" onclick="testLoadFromDatabase()">
                    –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º—É
                </button>
                <button class="btn btn-secondary" onclick="testSaveToDatabase()">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å (—Ç–µ—Å—Ç)
                </button>
            </div>
        </div>
        
        <hr>
        
        <form id="profile-edit-form">
            <div class="mb-3">
                <label for="callsigns-container" class="form-label">
                    <strong>–ú–æ–∏ –ø–æ–∑—ã–≤–Ω—ã–µ –≤ LoTW:</strong>
                </label>
                <div id="callsigns-container">
                    <!-- –ü–æ–ª—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addCallsign()">
                    + –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑—ã–≤–Ω–æ–π
                </button>
            </div>
            
            <input type="hidden" name="my_callsigns_json" id="my_callsigns_json" value='["CALL1", "CALL2"]'>
            
            <button type="submit" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
        
        <div id="results" class="mt-4">
            <h3>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞:</h3>
            <pre id="output" style="background: #f8f9fa; padding: 15px; border-radius: 5px;"></pre>
        </div>
    </div>

    <script>
        console.log('=== Profile Edit JS Loaded (FIXED VERSION) ===');
        
        // ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ==========
        
        function initProfileEdit() {
            console.log('Initializing profile edit...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –≤ —Ñ–æ—Ä–º—É
            loadProfileData();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            initEventHandlers();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞ –ø–æ–∑—ã–≤–Ω—ã—Ö
            initCallsignInputs();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function loadProfileData() {
            console.log('=== Loading profile data ===');
            
            const jsonField = document.getElementById('my_callsigns_json');
            if (!jsonField) {
                console.error('my_callsigns_json field not found!');
                return;
            }
            
            const rawData = jsonField.value.trim();
            console.log('Raw data from database:', rawData);
            
            if (!rawData || rawData === '[]') {
                console.log('No callsigns data found, adding empty field');
                addCallsign();
                return;
            }
            
            try {
                let callsigns;
                
                // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON
                try {
                    callsigns = JSON.parse(rawData);
                    console.log('Parsed callsigns:', callsigns);
                } catch (parseError) {
                    console.log('Failed to parse as JSON, treating as simple list');
                    // –ï—Å–ª–∏ –Ω–µ JSON, –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫
                    if (rawData.startsWith('[') && rawData.endsWith(']')) {
                        // –≠—Ç–æ JSON, –Ω–æ —Å –æ—à–∏–±–∫–æ–π –ø–∞—Ä—Å–∏–Ω–≥–∞
                        callsigns = [];
                    } else {
                        // –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫
                        callsigns = rawData.split(',').map(s => s.trim()).filter(s => s);
                    }
                }
                
                // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                const container = document.getElementById('callsigns-container');
                container.innerHTML = '';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑—ã–≤–Ω—ã–µ –≤ —Ñ–æ—Ä–º—É
                if (Array.isArray(callsigns)) {
                    if (callsigns.length === 0) {
                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–Ω–æ –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ
                        addCallsign();
                    } else {
                        callsigns.forEach(function(callsign) {
                            let callsignValue = '';
                            
                            if (typeof callsign === 'object' && callsign.name) {
                                callsignValue = callsign.name;
                            } else if (typeof callsign === 'string') {
                                callsignValue = callsign;
                            }
                            
                            addCallsign(callsignValue);
                        });
                    }
                    
                    console.log('Loaded callsigns into form');
                } else {
                    console.error('Invalid callsigns data format:', callsigns);
                    addCallsign();
                }
                
            } catch (error) {
                console.error('Error loading profile data:', error);
                addCallsign();
            }
        }
        
        // ========== Callsign Management Functions ==========
        
        // Initialize handlers for existing callsign inputs
        function initCallsignInputs() {
            document.querySelectorAll('.callsign-input').forEach(input => {
                input.addEventListener('input', function() {
                    this.value = this.value.toUpperCase().replace(/[^A-Z0-9\\/]/g, '');
                });
            });
            console.log('Initialized callsign inputs');
        }

        // Add new callsign input
        function addCallsign(value = '') {
            const container = document.getElementById('callsigns-container');
            const item = document.createElement('div');
            item.className = 'my-callsign-item mb-2 d-flex';
            item.innerHTML = `
                <input type="text" class="form-control name-input callsign-input flex-grow-1 me-2"
                       name="my_callsigns_names[]"
                       value="${value}"
                       placeholder="–ü–æ–∑—ã–≤–Ω–æ–π"
                       autocomplete="off">
                <button type="button" class="btn btn-outline-danger btn-sm"
                        onclick="removeCallsign(this)">
                    ‚úï
                </button>
            `;
            container.appendChild(item);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è
            initCallsignInputs();
            
            console.log('Added callsign input:', value);
        }

        // Remove callsign input
        function removeCallsign(button) {
            const container = document.getElementById('callsigns-container');
            const items = container.querySelectorAll('.my-callsign-item');
            
            if (items.length > 1) {
                // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç
                const item = button.closest('.my-callsign-item');
                item.remove();
                console.log('Removed callsign input, remaining:', items.length - 1);
            } else {
                // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç, –ø—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º –µ–≥–æ
                const item = button.closest('.my-callsign-item');
                const input = item.querySelector('input');
                input.value = '';
                console.log('Cleared last callsign input');
            }
        }
        
        // ========== Event Handlers ==========
        
        function initEventHandlers() {
            const form = document.getElementById('profile-edit-form');
            if (!form) {
                console.error('Profile form not found!');
                return;
            }
            
            // Form submit handler
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                console.log('=== DEBUG: Form Submit ===');
                console.log('Form submit triggered');
                
                const callsigns = [];
                const container = document.getElementById('callsigns-container');
                const items = container.querySelectorAll('.my-callsign-item');

                console.log('Found items:', items.length);
                
                items.forEach(function(item, index) {
                    const input = item.querySelector('input[name="my_callsigns_names[]"]');
                    if (input) {
                        const name = input.value.trim();
                        console.log(`Item ${index}: "${name}"`);
                        if (name) {
                            callsigns.push({
                                name: name.toUpperCase()
                            });
                        }
                    }
                });

                console.log('Collected callsigns:', callsigns);
                
                const jsonField = document.getElementById('my_callsigns_json');
                if (jsonField) {
                    const jsonValue = JSON.stringify(callsigns);
                    jsonField.value = jsonValue;
                    console.log('JSON field value set to:', jsonValue);
                    
                    // Debug: –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ–ø–∞–ª–∏ –≤ –ø–æ–ª–µ
                    console.log('JSON field after setting:', jsonField.value);
                } else {
                    console.error('my_callsigns_json field not found!');
                }
                
                // Debug: –ø—Ä–æ–≤–µ—Ä–∏–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
                const formData = new FormData(form);
                console.log('Form data my_callsigns_json:', formData.get('my_callsigns_json'));
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                const output = document.getElementById('output');
                output.textContent = `
–§–û–†–ú–ê –û–¢–ü–†–ê–í–õ–ï–ù–ê –£–°–ü–ï–®–ù–û!
======================

–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ${document.getElementById('my_callsigns_json').value}
–°–æ–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑—ã–≤–Ω—ã–µ: ${JSON.stringify(callsigns, null, 2)}
JSON –ø–æ–ª–µ: ${jsonField.value}
–ü—Ä–æ–≤–µ—Ä–∫–∞: ${jsonField.value === JSON.stringify(callsigns)}

–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä Django!
                `;
                
                return false; // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            });
            
            console.log('Event handlers initialized');
        }
        
        // ========== Test Functions ==========
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        function showDatabaseInfo() {
            const jsonField = document.getElementById('my_callsigns_json');
            const rawData = jsonField.value.trim();
            
            let info = `–î–∞–Ω–Ω—ã–µ –≤ —Å–∫—Ä—ã—Ç–æ–º –ø–æ–ª–µ:
${rawData}

–ü–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:
`;
            
            try {
                const parsed = JSON.parse(rawData);
                info += `–£—Å–ø–µ—à–Ω–æ! –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–ª: ${JSON.stringify(parsed, null, 2)}
–¢–∏–ø: ${typeof parsed} (${Array.isArray(parsed) ? '–º–∞—Å—Å–∏–≤' : '–Ω–µ –º–∞—Å—Å–∏–≤'})`;
                
                if (Array.isArray(parsed)) {
                    info += `\n\n–≠–ª–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∏–≤–∞:`;
                    parsed.forEach((item, i) => {
                        info += `\n  [${i}] ${item} (—Ç–∏–ø: ${typeof item})`;
                    });
                }
            } catch (e) {
                info += `–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ${e.message}`;
            }
            
            document.getElementById('databaseInfo').textContent = info;
        }
        
        // –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        window.testLoadFromDatabase = function() {
            console.log('=== –¢–ï–°–¢ –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–• ===');
            showDatabaseInfo();
            loadProfileData();
            
            const output = document.getElementById('output');
            output.textContent = `
–¢–ï–°–¢ –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–• –í–´–ü–û–õ–ù–ï–ù
=============================

‚úì –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è –≤ —Ñ–æ—Ä–º—É
‚úì –ü–æ–ª—è –ø–æ–∑—ã–≤–Ω—ã—Ö –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ –±–∞–∑—ã
‚úì JavaScript –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–∞—Ä—Å–∏—Ç JSON –¥–∞–Ω–Ω—ã–µ

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª—è –≤–≤–æ–¥–∞ –≤—ã—à–µ - –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
            `;
        };
        
        // –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        window.testSaveToDatabase = function() {
            console.log('=== –¢–ï–°–¢ –°–û–•–†–ê–ù–ï–ù–ò–Ø –î–ê–ù–ù–´–• ===');
            
            const form = document.getElementById('profile-edit-form');
            const event = new Event('submit');
            form.dispatchEvent(event);
        };
        
        // ========== Initialize ==========
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initProfileEdit);
        } else {
            initProfileEdit();
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–∑–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        setTimeout(showDatabaseInfo, 500);
    </script>
</body>
</html>