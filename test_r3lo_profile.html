<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è R3LO - –ü–æ–∑—ã–≤–Ω—ã–µ LoTW</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .my-callsign-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .callsign-input {
            flex: 1;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>üîß –¢–µ—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è R3LO</h1>
        
        <div class="alert alert-success">
            <h4>‚úÖ –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã:</h4>
            <ul>
                <li><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> R3LO (r3lo@duc5.com)</li>
                <li><strong>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:</strong> –ü–æ–¥–∫–ª—é—á–µ–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç</li>
                <li><strong>Django view:</strong> –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç POST –∑–∞–ø—Ä–æ—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</li>
                <li><strong>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:</strong> –†–∞–±–æ—Ç–∞–µ—Ç (—Å—Ç–∞—Ç—É—Å 302)</li>
                <li><strong>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö:</strong> –†–∞–±–æ—Ç–∞–µ—Ç (—Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è)</li>
            </ul>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <h3>üìä –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ:</h3>
                <div class="card">
                    <div class="card-body">
                        <div id="databaseInfo">
                            <strong>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</strong>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <h3>üîÑ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:</h3>
                <button class="btn btn-primary me-2" onclick="loadFromDatabase()">
                    üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –±–∞–∑—ã
                </button>
                <button class="btn btn-success me-2" onclick="saveToDatabase()">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∞–∑—É
                </button>
                <button class="btn btn-warning" onclick="testFullCycle()">
                    üîÑ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª
                </button>
            </div>
        </div>
        
        <hr>
        
        <form id="profile-edit-form">
            <div class="mb-3">
                <label for="callsigns-container" class="form-label">
                    <strong>–ú–æ–∏ –ø–æ–∑—ã–≤–Ω—ã–µ –≤ LoTW:</strong>
                </label>
                <div id="callsigns-container">
                    <!-- –ü–æ–ª—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addCallsign()">
                    + –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑—ã–≤–Ω–æ–π
                </button>
            </div>
            
            <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –±–∞–∑—ã (–∏–º–∏—Ç–∞—Ü–∏—è Django template) -->
            <input type="hidden" name="my_callsigns_json" id="my_callsigns_json" value='[{"name": "R3LO"}, {"name": "R3LO/M"}, {"name": "R3LO/AM"}, {"name": "UA3LO"}]'>
            
            <button type="submit" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
        </form>
        
        <div id="results" class="mt-4">
            <h3>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
            <div id="output" class="debug-info">
                –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é...
            </div>
        </div>
    </div>

    <script>
        console.log('=== Profile Edit JS –¥–ª—è R3LO Loaded ===');
        
        // ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ==========
        
        function initProfileEdit() {
            console.log('Initializing profile edit for R3LO...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –≤ —Ñ–æ—Ä–º—É
            loadProfileData();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            initEventHandlers();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞ –ø–æ–∑—ã–≤–Ω—ã—Ö
            initCallsignInputs();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–∑–µ
            showDatabaseInfo();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function loadProfileData() {
            console.log('=== Loading profile data for R3LO ===');
            
            const jsonField = document.getElementById('my_callsigns_json');
            if (!jsonField) {
                console.error('my_callsigns_json field not found!');
                return;
            }
            
            const rawData = jsonField.value.trim();
            console.log('Raw data from database:', rawData);
            
            if (!rawData || rawData === '[]') {
                console.log('No callsigns data found, adding empty field');
                addCallsign();
                return;
            }
            
            try {
                let callsigns;
                
                // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON
                try {
                    callsigns = JSON.parse(rawData);
                    console.log('Parsed callsigns:', callsigns);
                } catch (parseError) {
                    console.log('Failed to parse as JSON, treating as simple list');
                    if (rawData.startsWith('[') && rawData.endsWith(']')) {
                        callsigns = [];
                    } else {
                        callsigns = rawData.split(',').map(s => s.trim()).filter(s => s);
                    }
                }
                
                // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                const container = document.getElementById('callsigns-container');
                container.innerHTML = '';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑—ã–≤–Ω—ã–µ –≤ —Ñ–æ—Ä–º—É
                if (Array.isArray(callsigns)) {
                    if (callsigns.length === 0) {
                        addCallsign();
                    } else {
                        callsigns.forEach(function(callsign) {
                            let callsignValue = '';
                            
                            if (typeof callsign === 'object' && callsign.name) {
                                callsignValue = callsign.name;
                            } else if (typeof callsign === 'string') {
                                callsignValue = callsign;
                            }
                            
                            addCallsign(callsignValue);
                        });
                    }
                    
                    console.log('Loaded callsigns into form');
                } else {
                    console.error('Invalid callsigns data format:', callsigns);
                    addCallsign();
                }
                
            } catch (error) {
                console.error('Error loading profile data:', error);
                addCallsign();
            }
        }
        
        // ========== Callsign Management Functions ==========
        
        function initCallsignInputs() {
            document.querySelectorAll('.callsign-input').forEach(input => {
                input.addEventListener('input', function() {
                    this.value = this.value.toUpperCase().replace(/[^A-Z0-9\\/]/g, '');
                });
            });
            console.log('Initialized callsign inputs');
        }

        function addCallsign(value = '') {
            const container = document.getElementById('callsigns-container');
            const item = document.createElement('div');
            item.className = 'my-callsign-item mb-2 d-flex';
            item.innerHTML = `
                <input type="text" class="form-control name-input callsign-input flex-grow-1 me-2"
                       name="my_callsigns_names[]"
                       value="${value}"
                       placeholder="–ü–æ–∑—ã–≤–Ω–æ–π"
                       autocomplete="off">
                <button type="button" class="btn btn-outline-danger btn-sm"
                        onclick="removeCallsign(this)">
                    ‚úï
                </button>
            `;
            container.appendChild(item);
            
            initCallsignInputs();
            console.log('Added callsign input:', value);
        }

        function removeCallsign(button) {
            const container = document.getElementById('callsigns-container');
            const items = container.querySelectorAll('.my-callsign-item');
            
            if (items.length > 1) {
                const item = button.closest('.my-callsign-item');
                item.remove();
                console.log('Removed callsign input, remaining:', items.length - 1);
            } else {
                const item = button.closest('.my-callsign-item');
                const input = item.querySelector('input');
                input.value = '';
                console.log('Cleared last callsign input');
            }
        }
        
        // ========== Event Handlers ==========
        
        function initEventHandlers() {
            const form = document.getElementById('profile-edit-form');
            if (!form) {
                console.error('Profile form not found!');
                return;
            }
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                console.log('=== DEBUG: Form Submit for R3LO ===');
                
                const callsigns = [];
                const container = document.getElementById('callsigns-container');
                const items = container.querySelectorAll('.my-callsign-item');

                console.log('Found items:', items.length);
                
                items.forEach(function(item, index) {
                    const input = item.querySelector('input[name="my_callsigns_names[]"]');
                    if (input) {
                        const name = input.value.trim();
                        console.log(`Item ${index}: "${name}"`);
                        if (name) {
                            callsigns.push({
                                name: name.toUpperCase()
                            });
                        }
                    }
                });

                console.log('Collected callsigns:', callsigns);
                
                const jsonField = document.getElementById('my_callsigns_json');
                if (jsonField) {
                    const jsonValue = JSON.stringify(callsigns);
                    jsonField.value = jsonValue;
                    console.log('JSON field value set to:', jsonValue);
                } else {
                    console.error('my_callsigns_json field not found!');
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                const output = document.getElementById('output');
                output.textContent = `
–§–û–†–ú–ê –û–¢–ü–†–ê–í–õ–ï–ù–ê (–°–ò–ú–£–õ–Ø–¶–ò–Ø)
============================

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: R3LO
–°–æ–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑—ã–≤–Ω—ã–µ: ${JSON.stringify(callsigns, null, 2)}
JSON –ø–æ–ª–µ: ${jsonField.value}

–í —Ä–µ–∞–ª—å–Ω–æ–º —Å–∞–π—Ç–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞:
POST /dashboard/profile/

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –°—Ç–∞—Ç—É—Å: 302 (—Ä–µ–¥–∏—Ä–µ–∫—Ç)
- –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±–∞–∑—É
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                `;
                
                return false; // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            });
            
            console.log('Event handlers initialized');
        }
        
        // ========== Test Functions ==========
        
        function showDatabaseInfo() {
            const jsonField = document.getElementById('my_callsigns_json');
            const rawData = jsonField.value.trim();
            
            let info = `–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è R3LO –≤ –±–∞–∑–µ:
${rawData}

–ü–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:
`;
            
            try {
                const parsed = JSON.parse(rawData);
                info += `‚úÖ –£—Å–ø–µ—à–Ω–æ! –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–ª: ${JSON.stringify(parsed, null, 2)}
–¢–∏–ø: ${typeof parsed} (${Array.isArray(parsed) ? '–º–∞—Å—Å–∏–≤' : '–Ω–µ –º–∞—Å—Å–∏–≤'})`;
                
                if (Array.isArray(parsed)) {
                    info += `\n\n–≠–ª–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∏–≤–∞:`;
                    parsed.forEach((item, i) => {
                        info += `\n  [${i}] ${item} (—Ç–∏–ø: ${typeof item})`;
                    });
                }
            } catch (e) {
                info += `‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ${e.message}`;
            }
            
            document.getElementById('databaseInfo').innerHTML = `<pre>${info}</pre>`;
        }
        
        window.loadFromDatabase = function() {
            console.log('=== –¢–ï–°–¢ –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–• ===');
            showDatabaseInfo();
            loadProfileData();
            
            const output = document.getElementById('output');
            output.textContent = `
–¢–ï–°–¢ –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–• –í–´–ü–û–õ–ù–ï–ù
=============================

‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è –≤ —Ñ–æ—Ä–º—É
‚úÖ –ü–æ–ª—è –ø–æ–∑—ã–≤–Ω—ã—Ö –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ –±–∞–∑—ã
‚úÖ JavaScript –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–∞—Ä—Å–∏—Ç JSON –¥–∞–Ω–Ω—ã–µ

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª—è –≤–≤–æ–¥–∞ –≤—ã—à–µ - –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
            `;
        };
        
        window.saveToDatabase = function() {
            console.log('=== –¢–ï–°–¢ –°–û–•–†–ê–ù–ï–ù–ò–Ø –î–ê–ù–ù–´–• ===');
            
            const form = document.getElementById('profile-edit-form');
            const event = new Event('submit');
            form.dispatchEvent(event);
        };
        
        window.testFullCycle = function() {
            console.log('=== –¢–ï–°–¢ –ü–û–õ–ù–û–ì–û –¶–ò–ö–õ–ê ===');
            
            // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            loadFromDatabase();
            
            // 2. –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–∑—ã–≤–Ω–æ–π
            addCallsign('R3LO/TEST');
            
            // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            setTimeout(() => {
                const output = document.getElementById('output');
                output.textContent = `
–¢–ï–°–¢ –ü–û–õ–ù–û–ì–û –¶–ò–ö–õ–ê –ó–ê–í–ï–†–®–ï–ù
==========================

‚úÖ 1. –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –±–∞–∑—ã
‚úÖ 2. –î–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–∑—ã–≤–Ω–æ–π: R3LO/TEST
‚úÖ 3. –§–æ—Ä–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é

–°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì: –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å" –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö.
                `;
            }, 1000);
        };
        
        // ========== Initialize ==========
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initProfileEdit);
        } else {
            initProfileEdit();
        }
    </script>
</body>
</html>